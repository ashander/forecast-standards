<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Forecasting Metadata • EFIstandards</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Forecasting Metadata">
<meta property="og:description" content="EFIstandards">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">EFIstandards</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/flare-metadata-example.html">Forecasting Metadata</a>
    </li>
    <li>
      <a href="../articles/logistic-metadata-example.html">Forecasting Metadata</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Forecasting Metadata</h1>
            
      
      
      <div class="hidden name"><code>flare-metadata-example.Rmd</code></div>

    </div>

    
    
<p>#Example using output from a FLARE forecast</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">EML</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">uuid</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ncdf4</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">lubridate</span>)
<span class="kw pkg">emld</span><span class="kw ns">::</span><span class="fu"><a href="https://docs.ropensci.org/emld/reference/eml_version.html">eml_version</a></span>(<span class="st">"eml-2.2.0"</span>)</pre></body></html></div>
<pre><code>## [1] "eml-2.2.0"</code></pre>
<p>First, set the forecast identifiers</p>
<p>ForecastProject_id represents the launch of an automated, iterative forecast. It is created each time a human modifies the forecast code. It can be a DOI because this is the level that we envision citations occuring.</p>
<p>Forecast_id represents each forecast cycle within a ForecastProject_id</p>
<p>For example, if you have a forecast code base on GitHub and launch a forecast from that code that runs daily for 365 days, then there will be one ForecastProject_id and 365 Forecast_ids. A paper analyzing the forecasts would cite the ForecastProject_id.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">ForecastProject_id</span> <span class="kw">&lt;-</span> <span class="fl">30405043</span> <span class="co">#Some ID that applies to a bunch of forecasts</span>
<span class="no">Forecast_id</span> <span class="kw">&lt;-</span> <span class="kw pkg">uuid</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/uuid/man/UUIDgenerate.html">UUIDgenerate</a></span>() <span class="co">#The ID that applies to the specific forecast in the cycel</span></pre></body></html></div>
<div id="scenario-1-oxygen-system-turned-on" class="section level1">
<h1 class="hasAnchor">
<a href="#scenario-1-oxygen-system-turned-on" class="anchor"></a>Scenario 1: Oxygen System turned on</h1>
<div id="generating-the-forecast" class="section level2">
<h2 class="hasAnchor">
<a href="#generating-the-forecast" class="anchor"></a>Generating the forecast</h2>
<p>First, get the output as we are currently saving it</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">nc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/nc_open.html">nc_open</a></span>(<span class="st">"IW2_1_SSSon_H_2019_05_27_2019_06_03_F_16_2132020_21_32.nc"</span>)

<span class="co">#Dimnesions</span>
<span class="no">depth</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_get.html">ncvar_get</a></span>(<span class="no">nc</span>, <span class="st">"z"</span>)
<span class="no">time</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_get.html">ncvar_get</a></span>(<span class="no">nc</span>,<span class="st">'time'</span>)
<span class="no">local_tzone</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncatt_get.html">ncatt_get</a></span>(<span class="no">nc</span>, <span class="fl">0</span>)$<span class="no">time_zone_of_simulation</span>
<span class="no">time</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span>(<span class="no">time</span>, <span class="kw">origin</span> <span class="kw">=</span> <span class="st">'1970-01-01 00:00.00 UTC'</span>, <span class="kw">tz</span> <span class="kw">=</span> <span class="no">local_tzone</span>)
<span class="no">time</span> <span class="kw">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/strptime.html">strftime</a></span>(<span class="no">time</span> , <span class="st">"%Y-%m-%dT%H:%M:%S%z"</span>)

<span class="co">#States</span>
<span class="no">temperature</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_get.html">ncvar_get</a></span>(<span class="no">nc</span>, <span class="st">"temp"</span>)
<span class="no">oxygen</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_get.html">ncvar_get</a></span>(<span class="no">nc</span>, <span class="st">"OXY_oxy"</span>)
<span class="no">zone1temp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_get.html">ncvar_get</a></span>(<span class="no">nc</span>, <span class="st">"zone1temp"</span>)
<span class="no">zone2temp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_get.html">ncvar_get</a></span>(<span class="no">nc</span>, <span class="st">"zone2temp"</span>)
<span class="no">sw_factor</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_get.html">ncvar_get</a></span>(<span class="no">nc</span>, <span class="st">"sw_factor"</span>)
<span class="no">inflow_factor</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_get.html">ncvar_get</a></span>(<span class="no">nc</span>, <span class="st">"inflow_factor"</span>)

<span class="co">#Forecast timings</span>
<span class="no">forecasted</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_get.html">ncvar_get</a></span>(<span class="no">nc</span>, <span class="st">"forecasted"</span>)
<span class="no">data_assimilation</span> <span class="kw">&lt;-</span> <span class="fu">if_else</span>(<span class="no">forecasted</span> <span class="kw">==</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>)
<span class="co">#This doesn't work but we need to update our writing script to just have the date</span>
<span class="no">forecast_issue_time</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncatt_get.html">ncatt_get</a></span>(<span class="no">nc</span>, <span class="kw">varid</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">attname</span> <span class="kw">=</span> <span class="st">"history"</span>)

<span class="no">forecast_issue_time</span> <span class="kw">&lt;-</span> <span class="st">"2020-02-13T21:32:52-05:00"</span>

<span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/nc_close.html">nc_close</a></span>(<span class="no">nc</span>)</pre></body></html></div>
</div>
<div id="saving-to-a-standardized-output-format-option-1" class="section level2">
<h2 class="hasAnchor">
<a href="#saving-to-a-standardized-output-format-option-1" class="anchor"></a>Saving to a standardized output format (Option 1)</h2>
<p>Second, build a data frame for all variables with a depth dimension</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">n_depths</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">depth</span>)
<span class="no">state_names</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"temperature"</span>, <span class="st">"oxygen"</span>)
<span class="no">states</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">temperature</span>, <span class="no">oxygen</span>)
<span class="no">n_states</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">state_names</span>)
<span class="no">df_combined</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()

<span class="kw">for</span>(<span class="no">k</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="no">n_states</span>){
<span class="kw">for</span>(<span class="no">i</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="no">n_depths</span>){
    <span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu">as_tibble</span>(<span class="no">states</span><span class="kw">[[</span><span class="no">k</span>]][, ,<span class="no">i</span>])
    <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">df</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">states</span><span class="kw">[[</span><span class="no">k</span>]][, ,<span class="no">i</span>])))
    <span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="no">time</span>, <span class="no">df</span>, <span class="no">data_assimilation</span>)
    <span class="no">df</span> <span class="kw">&lt;-</span> <span class="no">df</span> <span class="kw">%&gt;%</span>
      <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> -<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">time</span>,<span class="no">data_assimilation</span>),
                   <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"ensemble"</span>,
                   <span class="kw">values_to</span> <span class="kw">=</span> <span class="no">state_names</span>[<span class="no">k</span>]) <span class="kw">%&gt;%</span>
      <span class="fu">mutate</span>(<span class="kw">ensemble</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="no">ensemble</span>)) <span class="kw">%&gt;%</span>
      <span class="fu">mutate</span>(<span class="kw">depth</span> <span class="kw">=</span> <span class="no">depth</span>[<span class="no">i</span>])
    <span class="kw">if</span>(<span class="no">i</span> <span class="kw">==</span> <span class="fl">1</span>){
    <span class="no">running_df</span> <span class="kw">&lt;-</span> <span class="no">df</span>
    }<span class="kw">else</span>{
      <span class="no">running_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="no">running_df</span>, <span class="no">df</span>)
    }
}
      <span class="no">df_combined</span><span class="kw">[[</span><span class="no">k</span>]] <span class="kw">&lt;-</span> <span class="no">running_df</span>
}</pre></body></html></div>
<pre><code>## Warning: The `x` argument of `as_tibble.matrix()` must have column names if `.name_repair` is omitted as of tibble 2.0.0.
## Using compatibility `.name_repair`.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_warnings()` to see where this warning was generated.</code></pre>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">df_combined</span> <span class="kw">&lt;-</span> <span class="fu">right_join</span>(<span class="no">df_combined</span><span class="kw">[[</span><span class="fl">1</span>]], <span class="no">df_combined</span><span class="kw">[[</span><span class="fl">2</span>]],
                          <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"time"</span>, <span class="st">"ensemble"</span>, <span class="st">"depth"</span>, <span class="st">"data_assimilation"</span>)) <span class="kw">%&gt;%</span>
    <span class="fu">mutate</span>(<span class="kw">forecast_issue_time</span> <span class="kw">=</span> <span class="no">forecast_issue_time</span>,
         <span class="kw">ForecastProject_id</span> <span class="kw">=</span> <span class="no">ForecastProject_id</span>,
         <span class="kw">Forecast_id</span> <span class="kw">=</span> <span class="no">Forecast_id</span>,
         <span class="kw">scenario</span> <span class="kw">=</span> <span class="st">"oxygen_on"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">time</span>, <span class="no">depth</span>, <span class="no">scenario</span>, <span class="no">ensemble</span>, <span class="no">temperature</span>,
         <span class="no">oxygen</span>, <span class="no">forecast_issue_time</span>,
         <span class="no">data_assimilation</span>, <span class="no">Forecast_id</span>, <span class="no">ForecastProject_id</span>)

<span class="no">df_combined_scenario_1</span> <span class="kw">&lt;-</span> <span class="no">df_combined</span></pre></body></html></div>
<p>Second, build a data frame for all variables without a depth dimension (parameters).</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu">as_tibble</span>(<span class="no">zone1temp</span>[ , ])
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">df</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">zone1temp</span>)))
<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="no">time</span>, <span class="no">data_assimilation</span>, <span class="no">df</span>)
<span class="no">df_combined_p1</span> <span class="kw">&lt;-</span> <span class="no">df</span> <span class="kw">%&gt;%</span>
      <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> -<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"time"</span>, <span class="st">"data_assimilation"</span>),
                   <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"ensemble"</span>,
                   <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"zone1temp"</span>) <span class="kw">%&gt;%</span>
      <span class="fu">mutate</span>(<span class="kw">ensemble</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="no">ensemble</span>),
             <span class="kw">scenario</span> <span class="kw">=</span> <span class="st">"oxygen_on"</span>)

<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu">as_tibble</span>(<span class="no">zone2temp</span>[ , ])
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">df</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">zone2temp</span>)))
<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="no">time</span>, <span class="no">data_assimilation</span>, <span class="no">df</span>)
<span class="no">df_combined_p2</span> <span class="kw">&lt;-</span> <span class="no">df</span> <span class="kw">%&gt;%</span>
      <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> -<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"time"</span>, <span class="st">"data_assimilation"</span>),
                   <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"ensemble"</span>,
                   <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"zone2temp"</span>) <span class="kw">%&gt;%</span>
      <span class="fu">mutate</span>(<span class="kw">ensemble</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="no">ensemble</span>),
             <span class="kw">scenario</span> <span class="kw">=</span> <span class="st">"oxygen_on"</span>)

<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu">as_tibble</span>(<span class="no">sw_factor</span>[ , ])
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">df</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">sw_factor</span>)))
<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="no">time</span>, <span class="no">data_assimilation</span>, <span class="no">df</span>)
<span class="no">df_combined_p3</span> <span class="kw">&lt;-</span> <span class="no">df</span> <span class="kw">%&gt;%</span>
      <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> -<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"time"</span>, <span class="st">"data_assimilation"</span>),
                   <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"ensemble"</span>,
                   <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"sw_factor"</span>) <span class="kw">%&gt;%</span>
      <span class="fu">mutate</span>(<span class="kw">ensemble</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="no">ensemble</span>),
             <span class="kw">scenario</span> <span class="kw">=</span> <span class="st">"oxygen_on"</span>)

<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu">as_tibble</span>(<span class="no">inflow_factor</span>[ , ])
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">df</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">inflow_factor</span>)))
<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="no">time</span>, <span class="no">data_assimilation</span>, <span class="no">df</span>)
<span class="no">df_combined_p4</span> <span class="kw">&lt;-</span> <span class="no">df</span> <span class="kw">%&gt;%</span>
      <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> -<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"time"</span>, <span class="st">"data_assimilation"</span>),
                   <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"ensemble"</span>,
                   <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"inflow_factor"</span>) <span class="kw">%&gt;%</span>
      <span class="fu">mutate</span>(<span class="kw">ensemble</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="no">ensemble</span>),
             <span class="kw">scenario</span> <span class="kw">=</span> <span class="st">"oxygen_on"</span>)

<span class="no">df_parameters_1</span> <span class="kw">&lt;-</span> <span class="fu">right_join</span>(<span class="no">df_combined_p1</span>,
                              <span class="no">df_combined_p2</span>,
                              <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"time"</span>,
                                     <span class="st">"data_assimilation"</span>,
                                     <span class="st">"ensemble"</span>,
                                     <span class="st">"scenario"</span>)) <span class="kw">%&gt;%</span>
                  <span class="fu">right_join</span>(<span class="no">df_combined_p3</span>,
                              <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"time"</span>,
                                     <span class="st">"data_assimilation"</span>,
                                     <span class="st">"ensemble"</span>,
                                     <span class="st">"scenario"</span>)) <span class="kw">%&gt;%</span>
                  <span class="fu">right_join</span>(<span class="no">df_combined_p4</span>,
                              <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"time"</span>,
                                     <span class="st">"data_assimilation"</span>,
                                     <span class="st">"ensemble"</span>,
                                     <span class="st">"scenario"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">forecast_issue_time</span> <span class="kw">=</span> <span class="no">forecast_issue_time</span>,
         <span class="kw">Forecast_id</span> <span class="kw">=</span> <span class="no">Forecast_id</span>,
         <span class="kw">ForecastProject_id</span> <span class="kw">=</span> <span class="no">ForecastProject_id</span>) <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">time</span>, <span class="no">scenario</span>, <span class="no">ensemble</span>, <span class="no">forecast_issue_time</span>,
         <span class="no">data_assimilation</span>, <span class="no">Forecast_id</span>, <span class="no">ForecastProject_id</span>,
         <span class="no">zone1temp</span>, <span class="no">zone2temp</span>, <span class="no">sw_factor</span>, <span class="no">inflow_factor</span>)</pre></body></html></div>
</div>
</div>
<div id="scenario-2-oxygen-system-turned-off" class="section level1">
<h1 class="hasAnchor">
<a href="#scenario-2-oxygen-system-turned-off" class="anchor"></a>Scenario 2: Oxygen System turned off</h1>
<div id="generating-the-forecast-1" class="section level2">
<h2 class="hasAnchor">
<a href="#generating-the-forecast-1" class="anchor"></a>Generating the forecast</h2>
<p>First, get the output as we are currently saving it</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">nc</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/nc_open.html">nc_open</a></span>(<span class="st">"IW2_1_SSSoff_H_2019_05_27_2019_06_03_F_16_2132020_21_19.nc"</span>)

<span class="co">#Dimnesions</span>
<span class="no">depth</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_get.html">ncvar_get</a></span>(<span class="no">nc</span>, <span class="st">"z"</span>)
<span class="no">time</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_get.html">ncvar_get</a></span>(<span class="no">nc</span>,<span class="st">'time'</span>)
<span class="no">local_tzone</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncatt_get.html">ncatt_get</a></span>(<span class="no">nc</span>, <span class="fl">0</span>)$<span class="no">time_zone_of_simulation</span>
<span class="no">time</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span>(<span class="no">time</span>, <span class="kw">origin</span> <span class="kw">=</span> <span class="st">'1970-01-01 00:00.00 UTC'</span>, <span class="kw">tz</span> <span class="kw">=</span> <span class="no">local_tzone</span>)
<span class="no">time</span> <span class="kw">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/strptime.html">strftime</a></span>(<span class="no">time</span> , <span class="st">"%Y-%m-%dT%H:%M:%S%z"</span>)

<span class="co">#States</span>
<span class="no">temperature</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_get.html">ncvar_get</a></span>(<span class="no">nc</span>, <span class="st">"temp"</span>)
<span class="no">oxygen</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_get.html">ncvar_get</a></span>(<span class="no">nc</span>, <span class="st">"OXY_oxy"</span>)
<span class="no">zone1temp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_get.html">ncvar_get</a></span>(<span class="no">nc</span>, <span class="st">"zone1temp"</span>)
<span class="no">zone2temp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_get.html">ncvar_get</a></span>(<span class="no">nc</span>, <span class="st">"zone2temp"</span>)
<span class="no">sw_factor</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_get.html">ncvar_get</a></span>(<span class="no">nc</span>, <span class="st">"sw_factor"</span>)
<span class="no">inflow_factor</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_get.html">ncvar_get</a></span>(<span class="no">nc</span>, <span class="st">"inflow_factor"</span>)

<span class="co">#Forecast timings</span>
<span class="no">forecasted</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncvar_get.html">ncvar_get</a></span>(<span class="no">nc</span>, <span class="st">"forecasted"</span>)
<span class="no">data_assimilation</span> <span class="kw">&lt;-</span> <span class="fu">if_else</span>(<span class="no">forecasted</span> <span class="kw">==</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>)
<span class="co">#This doesn't work but we need to update our writing script to just have the date</span>
<span class="no">forecast_issue_time</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/ncatt_get.html">ncatt_get</a></span>(<span class="no">nc</span>, <span class="kw">varid</span><span class="kw">=</span><span class="fl">0</span>, <span class="kw">attname</span> <span class="kw">=</span> <span class="st">"history"</span>)
<span class="no">forecast_issue_time</span> <span class="kw">&lt;-</span> <span class="st">"2020-02-13T21:32:52-05:00"</span>

<span class="fu"><a href="https://rdrr.io/pkg/ncdf4/man/nc_close.html">nc_close</a></span>(<span class="no">nc</span>)</pre></body></html></div>
</div>
<div id="saving-to-a-standardized-output-format-option-1-1" class="section level2">
<h2 class="hasAnchor">
<a href="#saving-to-a-standardized-output-format-option-1-1" class="anchor"></a>Saving to a standardized output format (Option 1)</h2>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">n_depths</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">depth</span>)
<span class="no">state_names</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"temperature"</span>, <span class="st">"oxygen"</span>)
<span class="no">states</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">temperature</span>, <span class="no">oxygen</span>)
<span class="no">n_states</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">state_names</span>)
<span class="no">df_combined</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()

<span class="kw">for</span>(<span class="no">k</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="no">n_states</span>){
<span class="kw">for</span>(<span class="no">i</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="no">n_depths</span>){
    <span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu">as_tibble</span>(<span class="no">states</span><span class="kw">[[</span><span class="no">k</span>]][, ,<span class="no">i</span>])
    <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">df</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">states</span><span class="kw">[[</span><span class="no">k</span>]][, ,<span class="no">i</span>])))
    <span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="no">time</span>, <span class="no">df</span>, <span class="no">data_assimilation</span>)
    <span class="no">df</span> <span class="kw">&lt;-</span> <span class="no">df</span> <span class="kw">%&gt;%</span>
      <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> -<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">time</span>,<span class="no">data_assimilation</span>),
                   <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"ensemble"</span>,
                   <span class="kw">values_to</span> <span class="kw">=</span> <span class="no">state_names</span>[<span class="no">k</span>]) <span class="kw">%&gt;%</span>
      <span class="fu">mutate</span>(<span class="kw">ensemble</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="no">ensemble</span>)) <span class="kw">%&gt;%</span>
      <span class="fu">mutate</span>(<span class="kw">depth</span> <span class="kw">=</span> <span class="no">depth</span>[<span class="no">i</span>])
    <span class="kw">if</span>(<span class="no">i</span> <span class="kw">==</span> <span class="fl">1</span>){
    <span class="no">running_df</span> <span class="kw">&lt;-</span> <span class="no">df</span>
    }<span class="kw">else</span>{
      <span class="no">running_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="no">running_df</span>, <span class="no">df</span>)
    }
}
      <span class="no">df_combined</span><span class="kw">[[</span><span class="no">k</span>]] <span class="kw">&lt;-</span> <span class="no">running_df</span>
}

<span class="no">df_combined</span> <span class="kw">&lt;-</span> <span class="fu">right_join</span>(<span class="no">df_combined</span><span class="kw">[[</span><span class="fl">1</span>]], <span class="no">df_combined</span><span class="kw">[[</span><span class="fl">2</span>]],
                          <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"time"</span>, <span class="st">"ensemble"</span>, <span class="st">"depth"</span>, <span class="st">"data_assimilation"</span>)) <span class="kw">%&gt;%</span>
    <span class="fu">mutate</span>(<span class="kw">forecast_issue_time</span> <span class="kw">=</span> <span class="no">forecast_issue_time</span>,
         <span class="kw">Forecast_id</span> <span class="kw">=</span> <span class="no">Forecast_id</span>,
         <span class="kw">ForecastProject_id</span> <span class="kw">=</span> <span class="no">ForecastProject_id</span>,
         <span class="kw">scenario</span> <span class="kw">=</span> <span class="st">"oxygen_off"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">time</span>, <span class="no">depth</span>, <span class="no">scenario</span>, <span class="no">ensemble</span>, <span class="no">temperature</span>,
         <span class="no">oxygen</span>, <span class="no">forecast_issue_time</span>,
         <span class="no">data_assimilation</span>, <span class="no">Forecast_id</span>, <span class="no">ForecastProject_id</span>)

<span class="no">df_combined_scenario_2</span> <span class="kw">&lt;-</span> <span class="no">df_combined</span></pre></body></html></div>
<p>Second, build a data frame for all variables without a depth dimension (parameters).</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu">as_tibble</span>(<span class="no">zone1temp</span>[ , ])
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">df</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">zone1temp</span>)))
<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="no">time</span>, <span class="no">data_assimilation</span>, <span class="no">df</span>)
<span class="no">df_combined_p1</span> <span class="kw">&lt;-</span> <span class="no">df</span> <span class="kw">%&gt;%</span>
      <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> -<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"time"</span>, <span class="st">"data_assimilation"</span>),
                   <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"ensemble"</span>,
                   <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"zone1temp"</span>) <span class="kw">%&gt;%</span>
      <span class="fu">mutate</span>(<span class="kw">ensemble</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="no">ensemble</span>),
             <span class="kw">scenario</span> <span class="kw">=</span> <span class="st">"oxygen_off"</span>)

<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu">as_tibble</span>(<span class="no">zone2temp</span>[ , ])
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">df</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">zone2temp</span>)))
<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="no">time</span>, <span class="no">data_assimilation</span>, <span class="no">df</span>)
<span class="no">df_combined_p2</span> <span class="kw">&lt;-</span> <span class="no">df</span> <span class="kw">%&gt;%</span>
      <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> -<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"time"</span>, <span class="st">"data_assimilation"</span>),
                   <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"ensemble"</span>,
                   <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"zone2temp"</span>) <span class="kw">%&gt;%</span>
      <span class="fu">mutate</span>(<span class="kw">ensemble</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="no">ensemble</span>),
             <span class="kw">scenario</span> <span class="kw">=</span> <span class="st">"oxygen_off"</span>)

<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu">as_tibble</span>(<span class="no">sw_factor</span>[ , ])
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">df</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">sw_factor</span>)))
<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="no">time</span>, <span class="no">data_assimilation</span>, <span class="no">df</span>)
<span class="no">df_combined_p3</span> <span class="kw">&lt;-</span> <span class="no">df</span> <span class="kw">%&gt;%</span>
      <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> -<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"time"</span>, <span class="st">"data_assimilation"</span>),
                   <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"ensemble"</span>,
                   <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"sw_factor"</span>) <span class="kw">%&gt;%</span>
      <span class="fu">mutate</span>(<span class="kw">ensemble</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="no">ensemble</span>),
             <span class="kw">scenario</span> <span class="kw">=</span> <span class="st">"oxygen_off"</span>)

<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu">as_tibble</span>(<span class="no">inflow_factor</span>[ , ])
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">df</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">inflow_factor</span>)))
<span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="no">time</span>, <span class="no">data_assimilation</span>, <span class="no">df</span>)
<span class="no">df_combined_p4</span> <span class="kw">&lt;-</span> <span class="no">df</span> <span class="kw">%&gt;%</span>
      <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> -<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"time"</span>, <span class="st">"data_assimilation"</span>),
                   <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"ensemble"</span>,
                   <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"inflow_factor"</span>) <span class="kw">%&gt;%</span>
      <span class="fu">mutate</span>(<span class="kw">ensemble</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span>(<span class="no">ensemble</span>),
             <span class="kw">scenario</span> <span class="kw">=</span> <span class="st">"oxygen_off"</span>)

<span class="no">df_parameters_2</span> <span class="kw">&lt;-</span> <span class="fu">right_join</span>(<span class="no">df_combined_p1</span>,
                              <span class="no">df_combined_p2</span>,
                              <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"time"</span>,
                                     <span class="st">"data_assimilation"</span>,
                                     <span class="st">"ensemble"</span>,
                                     <span class="st">"scenario"</span>)) <span class="kw">%&gt;%</span>
                  <span class="fu">right_join</span>(<span class="no">df_combined_p3</span>,
                              <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"time"</span>,
                                     <span class="st">"data_assimilation"</span>,
                                     <span class="st">"ensemble"</span>,
                                     <span class="st">"scenario"</span>)) <span class="kw">%&gt;%</span>
                  <span class="fu">right_join</span>(<span class="no">df_combined_p4</span>,
                              <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"time"</span>,
                                     <span class="st">"data_assimilation"</span>,
                                     <span class="st">"ensemble"</span>,
                                     <span class="st">"scenario"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">forecast_issue_time</span> <span class="kw">=</span> <span class="no">forecast_issue_time</span>,
         <span class="kw">Forecast_id</span> <span class="kw">=</span> <span class="no">Forecast_id</span>,
         <span class="kw">ForecastProject_id</span> <span class="kw">=</span> <span class="no">ForecastProject_id</span>) <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">time</span>, <span class="no">scenario</span>, <span class="no">ensemble</span>, <span class="no">forecast_issue_time</span>,
         <span class="no">data_assimilation</span>, <span class="no">Forecast_id</span>, <span class="no">ForecastProject_id</span>,
         <span class="no">zone1temp</span>, <span class="no">zone2temp</span>, <span class="no">sw_factor</span>, <span class="no">inflow_factor</span>)</pre></body></html></div>
</div>
<div id="saving-to-a-standardized-output-format-option-1-2" class="section level2">
<h2 class="hasAnchor">
<a href="#saving-to-a-standardized-output-format-option-1-2" class="anchor"></a>Saving to a standardized output format (Option 1)</h2>
<p>Create the 1D and 0D tables</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">df_combined_0D</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="no">df_parameters_1</span>, <span class="no">df_parameters_2</span>)
<span class="no">df_combined_1D</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="no">df_combined_scenario_1</span>, <span class="no">df_combined_scenario_2</span>)</pre></body></html></div>
<p>Write tables to CSV.</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span>(<span class="no">df_combined_1D</span>, <span class="st">"flare-forecast-ensemble-multi-variable-1D.csv"</span>, <span class="kw">row.names</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/write.table.html">write.csv</a></span>(<span class="no">df_combined_0D</span>, <span class="st">"flare-forecast-ensemble-parameters-0D.csv"</span>, <span class="kw">row.names</span> <span class="kw">=</span> <span class="fl">FALSE</span>)</pre></body></html></div>
</div>
<div id="standardized-metadata" class="section level2">
<h2 class="hasAnchor">
<a href="#standardized-metadata" class="anchor"></a>Standardized Metadata</h2>
<p>Let’s document the metadata of the data table itself. It may well be that we decide an Ecological Forecast has to have specific columns like the ones described above, which would thus correspond to a partially pre-defined attributes table (e.g. the units would probably still be allowed to vary, but format would be the same.)</p>
<p>Note one weakness of this format is that it assumes all data in a column have the same units. This common assumption might be violoated by transformations to “long” form data, where you have columns like “variable”, “value”, and “units”. (The long form may be useful, but it exposes much less information in the metadata layer – e.g. we no longer know what’s actually being measured without looking at the data file itself).</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="co">#attributes &lt;- tibble::tribble(</span>
<span class="co">#  ~attributeName, ~attributeDefinition, ~unit, ~formatString, ~numberType,</span>
<span class="co">#  "time",          "time",                       "year",     "YYYY-MM-DD%THH:MM_SS%Z", "numberType",</span>
<span class="co">#  "depth",         "depth in reservior",         "meter",   NA,          "real",</span>
<span class="co">#  "ensemble",      "index of ensemble member",   "dimensionless",    NA,         "integer",</span>
<span class="co">#  "scenario",      "forecast scenario",   "dimensionless",    NA, NA,  NA, "scenario name",</span>
<span class="co">#  </span>
<span class="co">#  ##### EDIT STARTING HERE</span>
<span class="co">#  "temperature",     "water temperature", "celsius", NA,  "real", NA,</span>
<span class="co">#  "oxygen",     "oxygen concentration", "numberPerMeterSquared", NA,  "real", NA,</span>
<span class="co">#  #### EDIT ENDING HERE</span>
<span class="co">#  </span>
<span class="co">#  "forecast_issue_time",     "time that forecast was created", "dimensionless", "YYYY-MM-DD",  "numberType",</span>
<span class="co">#  "data_assimilation",     "Flag whether time step included data assimilation", "dimensionless", NA, "integer",</span>
<span class="co">#  "Forecast_id",     "ID for specific forecast cycle", "dimensionless", NA,  "character",</span>
<span class="co">#  "ForecastProject_id",     "ID for forecasting project", "dimensionless", NA,  "character",</span>
<span class="co">#  )</span>

<span class="no">attributes</span> <span class="kw">&lt;-</span> <span class="kw pkg">tibble</span><span class="kw ns">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span>(
  ~<span class="no">attributeName</span>, ~<span class="no">attributeDefinition</span>, ~<span class="no">unit</span>, ~<span class="no">formatString</span>, ~<span class="no">numberType</span>, ~<span class="no">definition</span>,
  <span class="st">"time"</span>,          <span class="st">"time"</span>,                       <span class="st">"year"</span>,     <span class="st">"YYYY-MM-DD"</span>, <span class="st">"numberType"</span>, <span class="fl">NA</span>,
  <span class="st">"depth"</span>,         <span class="st">"depth in reservior"</span>,         <span class="st">"meter"</span>,   <span class="fl">NA</span>,          <span class="st">"real"</span>, <span class="fl">NA</span>,
  <span class="st">"ensemble"</span>,      <span class="st">"index of ensemble member"</span>,   <span class="st">"dimensionless"</span>,    <span class="fl">NA</span>,         <span class="st">"integer"</span>, <span class="fl">NA</span>,
   <span class="st">"scenario"</span>,      <span class="st">"forecast scenario"</span>,    <span class="fl">NA</span>, <span class="fl">NA</span>,  <span class="fl">NA</span>, <span class="st">"scenario name"</span>,
  <span class="st">"temperature"</span>,     <span class="st">"water temperature"</span>, <span class="st">"celsius"</span>, <span class="fl">NA</span>,  <span class="st">"real"</span>, <span class="fl">NA</span>,
  <span class="st">"oxygen"</span>,     <span class="st">"oxygen concentration"</span>, <span class="st">"numberPerMeterSquared"</span>, <span class="fl">NA</span>,  <span class="st">"real"</span>, <span class="fl">NA</span>,
  <span class="st">"forecast_issue_time"</span>,     <span class="st">"time that forecast was created"</span>, <span class="fl">NA</span>, <span class="st">"YYYY-MM-DD"</span>,  <span class="fl">NA</span>, <span class="fl">NA</span>,
  <span class="st">"data_assimilation"</span>,     <span class="st">"Flag whether time step included data assimilation"</span>, <span class="st">"dimensionless"</span>, <span class="fl">NA</span>, <span class="st">"integer"</span>, <span class="fl">NA</span>,
  <span class="st">"Forecast_id"</span>,     <span class="st">"ID for specific forecast cycle"</span>, <span class="fl">NA</span>, <span class="fl">NA</span>,  <span class="fl">NA</span>, <span class="st">"forecast id"</span>,
  <span class="st">"ForecastProject_id"</span>,     <span class="st">"ID for forecasting project"</span>, <span class="fl">NA</span>, <span class="fl">NA</span>,  <span class="fl">NA</span>, <span class="st">"project id"</span>
)


<span class="no">attrList</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/EML/reference/set_attributes.html">set_attributes</a></span>(<span class="no">attributes</span>,
                           <span class="kw">col_classes</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Date"</span>, <span class="st">"numeric"</span>, <span class="st">"character"</span>, <span class="st">"numeric"</span>,
                                           <span class="co">#EDIT STARTING HERE </span>
                                           <span class="st">"numeric"</span>,<span class="st">"numeric"</span>,
                                           <span class="co">#EDIT ENDING HERE</span>
                                           <span class="st">"Date"</span>,
                                           <span class="st">"numeric"</span>, <span class="st">"character"</span>, <span class="st">"character"</span>))</pre></body></html></div>
<pre><code>## Warning in set_attribute(attributes[i, ], factors = factors, missingValues
## = missingValues): Unit 'NA' is not a recognized standard unit; treating
## as custom unit. Please be sure you also define a custom unit in your EML
## record, or replace with a recognized standard unit. For unitless values, use
## "dimensionless" as the unit. See set_unitList() for details.</code></pre>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">physical</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/EML/reference/set_physical.html">set_physical</a></span>(<span class="st">"flare-forecast-ensemble-multi-variable-1D.csv"</span>)</pre></body></html></div>
<pre><code>## Automatically calculated file size using file.size("flare-forecast-ensemble-multi-variable-1D.csv")</code></pre>
<pre><code>## Automatically calculated authentication size using digest::digest("flare-forecast-ensemble-multi-variable-1D.csv", algo = "md5", file = TRUE)</code></pre>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">dataTable</span> <span class="kw">&lt;-</span> <span class="no">eml</span>$<span class="fu">dataTable</span>(
                 <span class="kw">entityName</span> <span class="kw">=</span> <span class="st">"flare-forecast-ensemble-multi-variable-1D.csv"</span>,
                 <span class="kw">entityDescription</span> <span class="kw">=</span> <span class="st">"Falling Creek Reservior Forecast"</span>,
                 <span class="kw">physical</span> <span class="kw">=</span> <span class="no">physical</span>,
                 <span class="kw">attributeList</span> <span class="kw">=</span> <span class="no">attrList</span>)</pre></body></html></div>
<p>There’s a lot more optional terminology that could be exploited here – for instance, the specification lets us define different missing value codes (and explanations) for each column, and allows us to indicate <code>precision</code>, <code>minimum</code> and <code>maximum</code>.</p>
<p>Note that <code>physical</code> type can document almost any formats as well, including NetCDF etc. A NetCDF file would still document the variables measured in much the same way regardless of the underlying representation. Note that</p>
<p>Now that we’ve documented the actual data.frame itself, we can add additional metadata to the record describing our forecast, which is essential for citing, discovering, and interpreting the result. We start with some authorship information.</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="no">me</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">individualName</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">givenName</span> <span class="kw">=</span> <span class="st">"Quinn"</span>,
                                 <span class="kw">surName</span> <span class="kw">=</span> <span class="st">"Thomas"</span>),
           <span class="kw">electronicMailAddress</span> <span class="kw">=</span> <span class="st">"rqthomas@vt.edu"</span>,
           <span class="kw">id</span> <span class="kw">=</span> <span class="st">"https://orcid.org/0000-0003-1282-7825"</span>)</pre></body></html></div>
<p>Set Taxonomic, Temporal, and Geographic Coverage.</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="no">coverage</span> <span class="kw">&lt;-</span>
  <span class="fu"><a href="https://docs.ropensci.org/EML/reference/set_coverage.html">set_coverage</a></span>(<span class="kw">begin</span> <span class="kw">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/as_date.html">as_datetime</a></span>(<span class="no">time</span>[<span class="fl">1</span>]),
               <span class="kw">end</span> <span class="kw">=</span> <span class="fu"><a href="http://lubridate.tidyverse.org/reference/as_date.html">as_datetime</a></span>(<span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>((<span class="no">time</span>)[<span class="fl">1</span>])),
               <span class="kw">geographicDescription</span> <span class="kw">=</span> <span class="st">"Falling Creek Reservior"</span>,
               <span class="kw">west</span> <span class="kw">=</span> -<span class="fl">79.9</span>, <span class="kw">east</span> <span class="kw">=</span> -<span class="fl">79.9</span>,
               <span class="kw">north</span> <span class="kw">=</span> <span class="fl">37.27</span>, <span class="kw">south</span> <span class="kw">=</span> <span class="fl">37.27</span>)</pre></body></html></div>
<p>Set key words. We will need to develop a EFI controlled vocabulary</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">keywordSet</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
        <span class="kw">keywordThesaurus</span> <span class="kw">=</span> <span class="st">"EFI controlled vocabulary"</span>,
        <span class="kw">keyword</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="st">"forecast"</span>,
                    <span class="st">"ecosystem"</span>,
                    <span class="st">"timeseries"</span>)
    ))</pre></body></html></div>
<p>Our dataset needs an abstract describing what this is all about. Also, a methods section is not required but it’s probably a good idea. Here we import a methods section that was written in Markdown.</p>
<p><strong>Forecast timestep</strong>: 1 day</p>
<p><strong>Forecast time horizon</strong> 16 days</p>
<p><strong>Data assimilation</strong></p>
<ul>
<li>Data Assimilation used: Yes</li>
<li>If, DA used - type of method: EnKF</li>
<li>If, DA used - Number of parameters calibrated: 3</li>
<li>If, DA used - Sources of training data (DOI, GitHub): <a href="https://github.com/CareyLabVT/SCCData/tree/carina-data" class="uri">https://github.com/CareyLabVT/SCCData/tree/carina-data</a>
</li>
</ul>
<p><strong>Model Description</strong></p>
<ul>
<li>Type of model (Empirical, process-based, machine learning): Process-based</li>
<li>Model name: General Lake Model-AED V3</li>
<li>Location of repository with model code: * GLM: <a href="https://github.com/AquaticEcoDynamics/GLM" class="uri">https://github.com/AquaticEcoDynamics/GLM</a> * AED: <a href="https://github.com/AquaticEcoDynamics/libaed2" class="uri">https://github.com/AquaticEcoDynamics/libaed2</a>
</li>
<li>Model citation: Hipsey et al. 2019 GMD</li>
<li>Total number of model process parameters: Hard to count</li>
</ul>
<p><strong>Model Covariates</strong></p>
<ul>
<li>Type (i.e., meteorology): meteorology, Stream Inflow</li>
<li>Source (i.e., NOAA GEFS): NOAA GEFS 16-day, <a href="https://github.com/CareyLabVT/SCCData/tree/diana-data" class="uri">https://github.com/CareyLabVT/SCCData/tree/diana-data</a>
</li>
</ul>
<p><strong>Uncertainty (No, Derived from data, Propagates, Assimilates)</strong></p>
<ul>
<li>Initial conditions: Assimilates</li>
<li>Parameter: Assimilates</li>
<li>Parameter Random Effects: No</li>
<li>Process (within model): Propagates, Assimilates</li>
<li>Multi-model: No</li>
<li>Driver: Derived from data</li>
<li>Scenario: Yes - oxygen system on and off</li>
<li>Method for propagating uncertainty (Analytic, ensemble numeric): ensemble numeric</li>
<li>If Analytic, specific method</li>
<li>If ensemble numeric, number of ensembles: 210</li>
</ul>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="no">abstract</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">markdown</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span>(<span class="st">"abstract.md"</span>), <span class="kw">collapse</span> <span class="kw">=</span> <span class="st">"\n"</span>))</pre></body></html></div>
<pre><code>## Warning in readLines("abstract.md"): incomplete final line found on
## 'abstract.md'</code></pre>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="no">methods</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">methodStep</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">description</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">markdown</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span>(<span class="st">"methods.md"</span>), <span class="kw">collapse</span> <span class="kw">=</span> <span class="st">"\n"</span>))))</pre></body></html></div>
<div class="sourceCode" id="cb26"><html><body><pre class="r"><span class="no">dataset</span> <span class="kw">=</span> <span class="no">eml</span>$<span class="fu">dataset</span>(
               <span class="kw">title</span> <span class="kw">=</span> <span class="st">"FLARE forecast"</span>,
               <span class="kw">creator</span> <span class="kw">=</span> <span class="no">me</span>,
               <span class="kw">contact</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">references</span><span class="kw">=</span><span class="st">"https://orcid.org/0000-0003-1282-7825"</span>),
               <span class="kw">pubDate</span> <span class="kw">=</span> <span class="no">forecast_issue_time</span>,
               <span class="kw">intellectualRights</span> <span class="kw">=</span> <span class="st">"http://www.lternet.edu/data/netpolicy.html."</span>,
               <span class="kw">abstract</span> <span class="kw">=</span>  <span class="st">"An illustration of how we might use EML metadata to describe an ecological forecast"</span>,
               <span class="kw">dataTable</span> <span class="kw">=</span> <span class="no">dataTable</span>,
               <span class="kw">keywordSet</span> <span class="kw">=</span> <span class="no">keywordSet</span>,
               <span class="kw">coverage</span> <span class="kw">=</span> <span class="no">coverage</span>,
               <span class="kw">methods</span> <span class="kw">=</span> <span class="no">methods</span>
               )</pre></body></html></div>
<p>All we need now is to add a unique identifier for the project and we are good to go! This could be a DOI or merely an identifier we create, e.g. a UUID.</p>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="no">my_eml</span> <span class="kw">&lt;-</span> <span class="no">eml</span>$<span class="fu"><a href="https://docs.ropensci.org/EML/reference/eml.html">eml</a></span>(<span class="kw">dataset</span> <span class="kw">=</span> <span class="no">dataset</span>,
           <span class="kw">packageId</span> <span class="kw">=</span> <span class="no">ForecastProject_id</span>,
           <span class="kw">system</span> <span class="kw">=</span> <span class="st">"uuid"</span>
           )</pre></body></html></div>
<p>Once we have finished building our EML metadata, we can confirm it is valid. This will catch any missing elements. (Recall that what is ‘required’ depends on what you include – for example, you don’t have to document a <code>dataTable</code> at all, but if you do, you have to document the “physical” file format it is in (e.g. <code>csv</code>) and the attributes and units it uses!)</p>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="fu"><a href="https://docs.ropensci.org/EML/reference/eml_validate.html">eml_validate</a></span>(<span class="no">my_eml</span>)</pre></body></html></div>
<pre><code>## [1] FALSE
## attr(,"errors")
## [1] "Element 'pubDate': '2020-02-13T21:32:52-05:00' is not a valid value of the union type '{https://eml.ecoinformatics.org/resource-2.2.0}yearDate'."
## [2] "Element 'calendarDate': '2019-05-27 12:00:00' is not a valid value of the union type '{https://eml.ecoinformatics.org/resource-2.2.0}yearDate'." 
## [3] "Element 'calendarDate': '2019-05-27 12:00:00' is not a valid value of the union type '{https://eml.ecoinformatics.org/resource-2.2.0}yearDate'." 
## [4] "Element 'nonNumericDomain': Missing child element(s). Expected is one of ( references, enumeratedDomain, textDomain )."                          
## [5] "Element 'numericDomain': This element is not expected. Expected is ( unit )."</code></pre>
<p>We are now ready to write out a valid EML document:</p>
<div class="sourceCode" id="cb30"><html><body><pre class="r"><span class="fu"><a href="https://docs.ropensci.org/EML/reference/write_eml.html">write_eml</a></span>(<span class="no">my_eml</span>, <span class="st">"forecast-flare-eml.xml"</span>)</pre></body></html></div>
<pre><code>## NULL</code></pre>
<p>At this point, we could easily upload this metadata along with the data itself to DataONE via the API (or <code>dataone</code> R package.)</p>
<p>We can also generate a JSON-LD version of EML:</p>
<div class="sourceCode" id="cb32"><html><body><pre class="r"><span class="kw pkg">emld</span><span class="kw ns">::</span><span class="fu"><a href="https://docs.ropensci.org/emld/reference/as_json.html">as_json</a></span>(<span class="fu"><a href="https://docs.ropensci.org/EML/reference/reexports.html">as_emld</a></span>(<span class="st">"forecast-flare-eml.xml"</span>), <span class="kw">file</span> <span class="kw">=</span> <span class="st">"forecast-flare-eml.json"</span>)</pre></body></html></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Carl Boettiger.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
